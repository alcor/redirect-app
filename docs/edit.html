<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Redirect.app</title>
<style>

  :root {
    --body-color:  #E9E9EB;
    --background-color:  #fefefe;
    --image-color:  #f8f8f8;
    --text-color:  #16161d;
    --body-color: var(--xarc-background-simple-color, #E9E9EB);
    --text-color: var(--xarc-palette-title, #16161d);
  }
  :root {
  /* --shadow-color: var(--arc-palette-title); */
  --shadow-color: var(--xarc-palette-background, #c6c6c6);
    --shadow-elevation-low:
      0px 1px 1.1px var(--shadow-color),
      0.1px 1.7px 1.9px -1.2px var(--shadow-color),
      0.2px 4px 4.5px -2.5px var(--shadow-color);
    --shadow-elevation-medium:
      0px 1px 1.1px var(--shadow-color),
      0.1px 3.3px 3.7px -0.8px var(--shadow-color),
      0.4px 8.2px 9.2px -1.7px var(--shadow-color),
      0.9px 20px 22.5px -2.5px var(--shadow-color);

  }
  /* media (prefers-color-scheme: dark) {
    :root {
      --body-color: #16161d;
      --background-color:  #16161d;
      --image-color:  #f8f8f8;
      --text-color:  #fafafa;
    }
  } */

  body {
    max-width:345px;
    margin:10vmin auto;
    background-color: var(--body-color);

  }

  body, input, textarea {
    font-family:sans-serif;

  }

  textarea {
      resize: none;
      border:0;
    background-color: transparent;
    padding:.5em;
    flex: 1 1 auto;
    margin:0 0.5em;
    }

  input {
    border:0;
    background-color: transparent;
    padding:0 1.5em;
    flex: 1 1 auto;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  input::placeholder {
    opacity:0.4;
  }
  input.i_preview {
    max-height:425px;
    min-width: 100px;
    min-height:100px;
    background-color: var(--image-color);
    padding:0;
    margin-bottom:0.5em;
  }

  textarea[name="t"] {
    font-weight:600;
    color:black;
  }

  textarea[name="d"] {
    max-height:5em;
  }
  textarea[name="u"] {
    opacity:0.5;
  }

  .column {
    display:flex;
    flex-direction:column;
    flex: 1 1 auto;
  }
  .row {
    display:flex;
    flex-direction:row;
  }

  .column div:first-child {
    flex: 10 1 auto;
  }
  form {
    background-color: var(--background-color);
    border-radius: 0.3em ;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    padding-bottom:1em;

    background-color: var(--background-color);
    box-shadow: var(--shadow-elevation-medium);
  }
  #container {
    transform:rotate(-2deg);
  }

  #f_preview {
    width:64px;
    height:64px;
    background-color:var(--image-color);
    flex: 0 0 auto;
    margin-right:12px;
    margin-top:4px;
    font-size:0;
    border-radius:4px;
  }

  #rurl, #linkbot {
    border:0;
    padding:0.5em 1.5em;
    font-size:0.8em;
    color:var(--text-color);
    font-family:monospace;
    width:100%;
    box-sizing:border-box;
  }
  #fetch {
    opacity:0.1;
    cursor:pointer;
  }
  #fetch:hover {
    opacity:1
  }

  </style>
<script>

let dashspaces = (s) => s.replace(/ +/g, " ").replace(/--/g, "—"/*em*/).replace(/-/g, "--").replace(/ -- /g, "_-_").replace(/ /g, "-");
let spacedashes = (s) => s.replace(/-/g, " ").replace(/  /g, "-").replace(/ -- /g, "_-_").replace(/ /g, "-");

function encodePrettyComponent(s) {
  let replacements = {' - ': '---', '-': '--', ' ' : '-'}
  let re = new RegExp('(' + Object.keys(replacements).join('|') + ')', 'g');
  return encodeURIComponent(s.replace(re, e => replacements[e] ?? '-'))
    // .replace(/\%2C/g, ",")
    .replace(/[!'()*]/g, (c) => '%' + c.charCodeAt(0).toString(16));
}

function decodePrettyComponent(s) {
  let replacements = {'---': ' - ', '--': '-','-' : ' '}
  return decodeURIComponent(s.replace(/-+/g, e => replacements[e] ?? '-'))
}
function encodeURL(u) {
  return encodeURIComponent(u).replace(/^https%3A%2F%2F/, "")
}
function decodeURL(s) {
  s = decodeURIComponent(s)
  if (s.startsWith("http")) s;
  return atob(s.replace(/=/g,''));
}


function metadataToPath(data) {
  if (!data || !data.title) return "/";
  let path = ["/" + encodePrettyComponent(data.title)];
  if (data.description) path.push("d/" + encodePrettyComponent(data.description.substring(0,200).split(". ").shift()));
  if (data.favicon) path.push("f/" + encodeURIComponent(data.favicon));
  if (data.image) path.push("i/" + encodeURIComponent(btoa(data.image).replace(/=/g, "")));
  return "/m" + path.join('/') + "/";
}

function pathToMetadata(path) {
  let components = path.substring(1).split("/");
  let info = {t: decodePrettyComponent(components.shift())}
  for (let i = 0; i < components.length; i+=2) {
    let key = components[i];
    let value = components[i+1];
    if (!value) continue;
    if (key == "d") { value = decodePrettyComponent(value); }
    if (key == "u" || key == "i") { value = decodeURL(value); }
    else if (value.includes("%")) { value = decodeURIComponent(value); }
    if (key.length && value.length) info[key] = value;
  }
  return info;
}



function cleanURL(url) {
  if (!url.startsWith("http")) url = "https://" + url;
  return url;
}

async function fetchMetadata() {
  let url = document.getElementById("u").value;
  if (!url) return;
  let metadata = await propogateData(url);


  console.log("metadata", metadata)
  if (metadata.title) document.getElementById("t").value = metadata.title;
  if (metadata.description) document.getElementById("d").value = metadata.description;
  if (metadata.imageSecureUrl) metadata.image = metadata.imageSecureUrl;
  if (metadata.image) document.getElementById("i").value = metadata.image;
  if (metadata.image) document.getElementById("i_preview").src = metadata.image;

  if (metadata.favicon) document.getElementById("f").value = metadata.favicon;
  if (metadata.favicon) document.getElementById("f_preview").src = metadata.favicon;
  if (metadata.site_name) document.getElementById("s").value = metadata.site_name;
  if (metadata.url) document.getElementById("u").value = metadata.url;
  parse();
}

async function propogateData(site) {
  console.log("fetching data for", site, "...")
  const url = `https://opengraph.io/api/1.1/site/${encodeURIComponent(cleanURL(site))}?use_proxy=true&app_id=02833a69-1109-4770-ac9e-b1abface4369`;

  try {
    const response = await fetch(url);
    const data = await response.json();
    console.log(data);
    return data.hybridGraph;
  } catch (error) {
    console.error(error);
  }

  return data;
}
function load() {
  console.log(location)
  let data = localStorage.getItem("data");
  if (location.pathname.length > 5) {
    let path = location.pathname.substring(5);
    data = pathToMetadata(path);
  } else if (data) {
    data = JSON.parse(data)    
  }
  
  if (data) {
    console.log("Restoring", data)
    let form = document.forms[0];
    for (let key in data) {
      console.log("key", key);
      form[key].value = data[key];
      if (!data[key].length) continue;
      if (key == "i") document.getElementById("i_preview").src = imageToURL(data[key]);
      if (key == "f") document.getElementById("f_preview").src = imageToURL(data[key]);
      console.log("key", key, data[key], form[key])
    }
    parse();
  }
}

function adjustHeight(el) {  /* javascript */
  el.style.height = "1px";
  el.style.height = (el.scrollHeight)+"px";
}

function parse() {
  let form = document.forms[0]

  let formData = new FormData(form);
  console.log("formdata", formData.keys)
  let formObj = Object.fromEntries(formData);
  console.log("DATA", formObj)
  localStorage.setItem("data", JSON.stringify(formObj));

  console.log("object", formObj);
  let url = formData.get("u");
  formData.delete("u")
  let title = formData.get("t");
  formData.delete("t")

  if (title) {
    let path = `/${encodePrettyComponent(title)}`
    let encodedFields = ["i", "v", "f"];
    formData.forEach((value, key) => {
      if (!value.length) return;
      if (encodedFields.includes(key)) {
        value = encodeURL(value)
      } else {
        value = encodePrettyComponent(value)
      }
      path += `/${key}/${value}`
    });
    
    // formData.forEach((value, key) => {if (value.length) object[key] = value});

    let hash = false;
    if (hash) {
      path += "/#" + url;
    } else {
      path += "/u/" + encodeURL(url) + "/";
    }
    

    console.log(path);
    

    let prefix = new URL(url).hostname.replace("www.", "").replace(".com","").replace(".", "-") + ".";
    origin = `https://${prefix}redirect.app`
    document.getElementById("rurl").value = `${origin}/m${path}`;

    let linkbot = `/embed url:${url} title:${title}`;
    if (formObj.d.length) linkbot += ` description:${formObj.d}`;
    if (formObj.i.length) linkbot += ` image:${formObj.i}`;

    document.getElementById("linkbot").value = linkbot;
    // history.replaceState(null, null, "edit" + path);
  }
    
  Array.from(document.querySelectorAll("textarea")).forEach((el) => {
    console.log("el", el)
    adjustHeight(el);
  })
}

function imageToURL(img) {
  if (img.startsWith("http")) return img;
  let codepoints = Array.from(img).map(c => c.codePointAt(0).toString(16));
  return `https://fonts.gstatic.com/s/e/notoemoji/14.0/${codepoints.join("_")}/128.png`
}
function getURL(el) {
  let url = prompt("Choose an emoji, image URL or SVG code");
  console.log(document.forms.t, el);
  

  if (url) {
    el.src = imageToURL(url);
    console.log("el", el.form)
    el.form.elements[el.getAttribute("target")].value = url;
  }
  parse();
}
var focusedElement;
function selectElement(el) {
  // if (focusedElement == el) return;
  focusedElement = el;
  setTimeout(function () { el.setSelectionRange(0, el.value.length) }, 10);

}

</script>

<div id="container">
<form id="form" onsubmit="parse(); return false;">
  <input id="i_preview" type="image" target="i" class="i_preview" onclick="getURL(this)" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='600' viewBox='0 0 1200 600'%3E%%3C/svg%3E%0A">
  <div class="row">
    <div class="column">
      <textarea id="t" name="t" oninput="parse()" placeholder="Title"></textarea>
      <textarea id="d" name="d" oninput="parse()" placeholder="Description"></textarea>
      <input id="s" name="s" type="hidden" oninput="parse()">
      <input id="i" name="i" type="hidden" oninput="parse()">
      <input id="f" name="f" type="hidden" oninput="parse()">
      <div class="row">
      <textarea id="u" name="u" oninput="parse()" oncontextmenu="fetchMetadata(); return false;" placeholder="example.com"></textarea>
      <div id="fetch" onclick="fetchMetadata()">↧</div>
      </div>
      <button type="sumbit" style="display:none">submit</button>
    </div>
    <input type="image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='600' viewBox='0 0 1200 600'%3E%%3C/svg%3E%0A" id="f_preview" target="f" onclick="getURL(this)" oninput="parse()" placeholder="icon">
  </div>

</form>
<textarea type="text" id="rurl" onclick="selectElement(this)" value="https://redirect.app/"></textarea>
<textarea type="text" id="linkbot" onclick="selectElement(this)" value="/embed url:"></textarea>
</div>
<script>
  load();

</script>