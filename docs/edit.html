<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Redirect.app</title>
<style>

  :root {
    --body-color:  #E9E9EB;
    --background-color:  #fefefe;
    --image-color:  #f8f8f8;
    --text-color:  #16161d;
    --body-color: var(--arc-palette-background);
    --text-color: var(--arc-palette-title)
  }
  media (prefers-color-scheme: dark) {
    :root {
      --body-color: #16161d;
      --background-color:  #16161d;
      --image-color:  #f8f8f8;
      --text-color:  #fafafa;
    }
  }

  body {
    max-width:345px;
    margin:10vmin auto;
    background-color: var(--body-color);

  }

  body, input, textarea {
    font-family:sans-serif;

  }

  textarea {
      resize: none;
      border:0;
    background-color: transparent;
    padding:.5em;
    flex: 1 1 auto;
    margin:0 0.5em;
    }

  input {
    border:0;
    background-color: transparent;
    padding:0 1.5em;
    flex: 1 1 auto;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  input::placeholder {
    opacity:0.4;
  }
  input.thumbnail {
    max-height:425px;
    min-width: 100px;
    min-height:100px;
    background-color: var(--image-color);
    padding:0;
    margin-bottom:0.5em;
  }

  textarea[name="t"] {
    font-weight:600;
    color:black;
  }

  textarea[name="d"] {

  }
  textarea[name="url"] {
    opacity:0.5;
  }

  .column {
    display:flex;
    flex-direction:column;
    flex: 1 1 auto;
  }
  .row {
    display:flex;
    flex-direction:row;
  }

  .column div:first-child {
    flex: 10 1 auto;
  }
  form {
    background-color: var(--background-color);
    border-radius: 0.3em ;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    padding-bottom:1em;

    background-color: var(--background-color);
    box-shadow: 0 10px 20px rgba(0,0,0,0.09), 0 6px 6px rgba(0,0,0,0.13);
  }
  #container {
    transform:rotate(-2deg);
  }

  #favicon {
    width:64px;
    height:64px;
    background-color:var(--image-color);
    flex: 0 0 auto;
    margin-right:16px;
    font-size:0;
  }

  #rurl, #linkbot {
    border:0;
    padding:0.5em 1.5em;
    font-size:0.8em;
    color:var(--text-color);
    font-family:monospace;
    width:100%;
    box-sizing:border-box;
  }
  #fetch {
    opacity:0.1;
    cursor:pointer;
  }
  #fetch:hover {
    opacity:1
  }

  </style>
<script>

let dashspaces = (s) => s.replace(/ +/g, " ").replace(/--/g, "—"/*em*/).replace(/-/g, "--").replace(/ -- /g, "_-_").replace(/ /g, "-");
let spacedashes = (s) => s.replace(/-/g, " ").replace(/  /g, "-").replace(/ -- /g, "_-_").replace(/ /g, "-");

function encodePrettyComponent(s) {
  let replacements = {' - ': '---', '-': '--', ' ' : '-'}
  let re = new RegExp('(' + Object.keys(replacements).join('|') + ')', 'g');
  return encodeURIComponent(s.replace(re, e => replacements[e] ?? '-'))
    // .replace(/\%2C/g, ",")
    .replace(/[!'()*]/g, (c) => '%' + c.charCodeAt(0).toString(16));
}

function metadataToPath(data) {
  if (!data || !data.title) return "/";
  let path = ["/" + encodePrettyComponent(data.title)];
  if (data.description) path.push("d/" + encodePrettyComponent(data.description.substring(0,200).split(". ").shift()));
  if (data.favicon) path.push("f/" + encodeURIComponent(data.favicon));
  if (data.image) path.push("i/" + encodeURIComponent(btoa(data.image).replace(/=/g, "")));
  return "/m" + path.join('/') + "/";
}


function cleanURL(url) {
  if (!url.startsWith("http")) url = "https://" + url;
  return url;
}

async function fetchMetadata() {
  let url = document.getElementById("url").value;
  if (!url) return;
  let metadata = await propogateData(url);


  console.log("metadata", metadata)
  if (metadata.title) document.getElementById("t").value = metadata.title;
  if (metadata.description) document.getElementById("d").value = metadata.description;
  if (metadata.image) document.getElementById("i").value = metadata.image;
  if (metadata.image) document.getElementById("thumbnail").src = metadata.image;
  if (metadata.site_name) document.getElementById("s").value = metadata.site_name;
  if (metadata.url) document.getElementById("url").value = metadata.url;
  parse();
}

async function propogateData(site) {
  console.log("fetching data for", site, "...")
  const url = `https://opengraph.io/api/1.1/site/${encodeURIComponent(cleanURL(site))}?use_proxy=true&app_id=02833a69-1109-4770-ac9e-b1abface4369`;

  try {
    const response = await fetch(url);
    const data = await response.json();
    console.log(data);
    return data.hybridGraph;
  } catch (error) {
    console.error(error);
  }

  return data;
}
function load() {
  let data = localStorage.getItem("data");
  if (data) {
    data = JSON.parse(data)
    console.log("Restoring", data)
    let form = document.forms[0];
    for (let key in data) {
      form[key].value = data[key];
      if (!data[key].length) continue;
      if (key == "i") document.getElementById("thumbnail").src = imageToURL(data[key]);
      if (key == "f") document.getElementById("favicon").src = imageToURL(data[key]);
      console.log("key", key, data[key], form[key])
    }
    parse();
  }
}

function adjustHeight(el) {  /* javascript */
  el.style.height = "1px";
  el.style.height = (el.scrollHeight)+"px";
}

function parse() {
  let form = document.forms[0]

  let formData = new FormData(form);
  console.log("formdata", formData.keys)
  let formObj = Object.fromEntries(formData);
  console.log("DATA", formObj)
  localStorage.setItem("data", JSON.stringify(formObj));

  console.log("object", formObj);
  let url = formData.get("url");
  formData.delete("url")
  let title = formData.get("t");
  formData.delete("t")

  if (!title.length) return;
  let path = `/${encodePrettyComponent(title)}`
  let encodedFields = ["i", "v"];
  formData.forEach((value, key) => {
    if (!value.length) return;
    if (encodedFields.includes(key)) {
      value = btoa(value)
    } else {
      value = encodePrettyComponent(value)
    }
    path += `/${key}/${value}`
  });
  
  // formData.forEach((value, key) => {if (value.length) object[key] = value});

  let hash = false;
  if (hash) {
    path += "/#" + url;
  } else {
    path += "/u/" + encodeURIComponent(url) + "/";
  }
  

  console.log(path);
  document.getElementById("rurl").value = `https://redirect.app/m${path}`;

  let linkbot = `/embed url:${url} title:${title}`;
  if (formObj.d.length) linkbot += ` description:${formObj.d}`;
  if (formObj.i.length) linkbot += ` image:${formObj.i}`;

  document.getElementById("linkbot").value = linkbot;
  // history.replaceState(null, null, "edit" + path);

    
  Array.from(document.querySelectorAll("textarea")).forEach((el) => {
    console.log("el", el)
    adjustHeight(el);
  })
}

function imageToURL(img) {
  if (img.startsWith("http")) return img;
  let codepoints = Array.from(img).map(c => c.codePointAt(0).toString(16));
  return `https://fonts.gstatic.com/s/e/notoemoji/14.0/${codepoints.join("_")}/128.png`
}
function getURL(el) {
  let url = prompt("Choose an emoji, image URL or SVG code");
  console.log(document.forms.t, el);
  let thumbnail = document.forms[0].t;

  if (url) {
    el.src = imageToURL(url);
    console.log("el", el.form)
    el.form.elements[el.getAttribute("target")].value = url;
  }
  parse();
}
var focusedElement;
function selectElement(el) {
  // if (focusedElement == el) return;
  focusedElement = el;
  setTimeout(function () { el.setSelectionRange(0, el.value.length) }, 10);

}

</script>

<div id="container">
<form id="form" onsubmit="parse(); return false;">
  <input id="thumbnail" type="image" target="i" class="thumbnail" onclick="getURL(this)" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='600' viewBox='0 0 1200 600'%3E%%3C/svg%3E%0A">
  <div class="row">
    <div class="column">
      <textarea id="t" name="t" oninput="parse()" placeholder="Title"></textarea>
      <textarea id="d" name="d" oninput="parse()" placeholder="Description"></textarea>
      <input id="s" name="s" type="hidden" oninput="parse()">
      <input id="i" name="i" type="hidden" oninput="parse()">
      <input id="f" name="f" type="hidden" oninput="parse()">
      <div class="row">
      <textarea id="url" name="url" oninput="parse()" oncontextmenu="fetchMetadata(); return false;" placeholder="example.com"></textarea>
      <div id="fetch" onclick="fetchMetadata()">↧</div>
      </div>
      <button type="sumbit" style="display:none">submit</button>
    </div>
    <input type="image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='600' viewBox='0 0 1200 600'%3E%%3C/svg%3E%0A" id="favicon" target="f" onclick="getURL(this)" oninput="parse()" placeholder="icon">
  </div>

</form>
<textarea type="text" id="rurl" onclick="selectElement(this)" value="https://redirect.app/"></textarea>
<textarea type="text" id="linkbot" onclick="selectElement(this)" value="/embed url:"></textarea>
</div>
<script>
  load();

</script>